<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Device Loading Test</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ccc; border-radius: 5px; }
        .success { background: #d4edda; border-color: #c3e6cb; }
        .error { background: #f8d7da; border-color: #f5c6cb; }
        .info { background: #d1ecf1; border-color: #b8daff; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 3px; overflow-x: auto; }
        button { padding: 8px 16px; margin: 5px; cursor: pointer; }
        select { width: 100%; padding: 8px; margin: 10px 0; }
    </style>
</head>
<body>
    <h1>üîç Biometric Device Loading Test</h1>
    
    <div class="test-section info">
        <h3>Test Progress</h3>
        <div id="progress">Starting tests...</div>
    </div>

    <div class="test-section">
        <h3>1. Agent Status Test</h3>
        <button onclick="testAgentStatus()">Test Agent Connection</button>
        <div id="agentResult"></div>
    </div>

    <div class="test-section">
        <h3>2. Agent Devices Test</h3>
        <button onclick="testAgentDevices()">Load Agent Devices</button>
        <div id="agentDevicesResult"></div>
    </div>

    <div class="test-section">
        <h3>3. Backend Devices Test</h3>
        <button onclick="testBackendDevices()">Test Backend API</button>
        <div id="backendResult"></div>
    </div>

    <div class="test-section">
        <h3>4. Integrated Device Loading Test</h3>
        <button onclick="testIntegratedLoading()">Test Complete Flow</button>
        <div id="integratedResult"></div>
        <div>
            <label>Device Selector:</label>
            <select id="testDeviceSelector">
                <option value="">No devices loaded</option>
            </select>
        </div>
    </div>

    <div class="test-section">
        <h3>5. Debug Console</h3>
        <pre id="debugConsole"></pre>
        <button onclick="clearConsole()">Clear Console</button>
    </div>

    <script>
        let debugOutput = [];
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}`;
            debugOutput.push(logEntry);
            document.getElementById('debugConsole').textContent = debugOutput.join('\n');
            console.log(logEntry);
            
            // Update progress
            document.getElementById('progress').innerHTML += `<br/>${logEntry}`;
        }

        function clearConsole() {
            debugOutput = [];
            document.getElementById('debugConsole').textContent = '';
            document.getElementById('progress').innerHTML = 'Console cleared.';
        }

        function updateResult(elementId, message, isSuccess = true) {
            const element = document.getElementById(elementId);
            element.innerHTML = message;
            element.className = isSuccess ? 'success' : 'error';
        }

        // Test 1: Agent Status
        async function testAgentStatus() {
            log('üîç Testing agent status...');
            try {
                const response = await fetch('http://localhost:5001/health', {
                    method: 'GET',
                    headers: { 'Accept': 'application/json' }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    log(`‚úÖ Agent is running: ${data.status}`);
                    updateResult('agentResult', `
                        <strong>‚úÖ Agent Connected!</strong><br/>
                        Status: ${data.status}<br/>
                        Version: ${data.version}<br/>
                        Hardware: ${data.hardware.total} devices (${data.hardware.ready} ready)<br/>
                        <pre>${JSON.stringify(data.hardware, null, 2)}</pre>
                    `);
                    return true;
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                log(`‚ùå Agent test failed: ${error.message}`);
                updateResult('agentResult', `‚ùå Agent connection failed: ${error.message}`, false);
                return false;
            }
        }

        // Test 2: Agent Devices
        async function testAgentDevices() {
            log('üîç Testing agent devices API...');
            try {
                const response = await fetch('http://localhost:5001/api/devices', {
                    method: 'GET',
                    headers: { 'Accept': 'application/json' }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    log(`‚úÖ Agent devices loaded: ${data.devices.length} devices`);
                    updateResult('agentDevicesResult', `
                        <strong>‚úÖ Agent Devices Loaded!</strong><br/>
                        Count: ${data.devices.length}<br/>
                        <pre>${JSON.stringify(data.devices, null, 2)}</pre>
                    `);
                    return data.devices;
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                log(`‚ùå Agent devices test failed: ${error.message}`);
                updateResult('agentDevicesResult', `‚ùå Agent devices failed: ${error.message}`, false);
                return [];
            }
        }

        // Test 3: Backend Devices
        async function testBackendDevices() {
            log('üîç Testing backend devices API...');
            try {
                // Note: This will likely fail due to auth, but we can see the response
                const response = await fetch('http://localhost:5000/api/biometric/devices/scan', {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json'
                        // No auth token for this test
                    }
                });
                
                const data = await response.json();
                log(`Backend response: HTTP ${response.status}`);
                
                if (response.ok) {
                    updateResult('backendResult', `
                        <strong>‚úÖ Backend API Working!</strong><br/>
                        Status: ${response.status}<br/>
                        <pre>${JSON.stringify(data, null, 2)}</pre>
                    `);
                } else {
                    updateResult('backendResult', `
                        <strong>‚ö†Ô∏è Backend API Response (Expected auth error)</strong><br/>
                        Status: ${response.status}<br/>
                        <pre>${JSON.stringify(data, null, 2)}</pre>
                    `);
                }
                return data;
            } catch (error) {
                log(`‚ùå Backend test failed: ${error.message}`);
                updateResult('backendResult', `‚ùå Backend API failed: ${error.message}`, false);
                return null;
            }
        }

        // Test 4: Integrated Loading (like the main page)
        async function testIntegratedLoading() {
            log('üîç Testing integrated device loading...');
            let devices = [];
            
            try {
                // Step 1: Try agent devices
                log('Step 1: Loading agent devices...');
                const agentDevices = await testAgentDevices();
                if (agentDevices && agentDevices.length > 0) {
                    const convertedDevices = agentDevices.map(device => ({
                        deviceId: device.id,
                        name: device.name || `${device.type} Device`,
                        vendor: 'Agent',
                        model: device.type,
                        category: device.type,
                        status: 'connected',
                        source: 'agent'
                    }));
                    devices.push(...convertedDevices);
                    log(`‚úÖ Added ${convertedDevices.length} agent devices`);
                }

                // Step 2: Try backend devices (will likely fail due to auth)
                log('Step 2: Trying backend devices...');
                try {
                    const backendResponse = await fetch('http://localhost:5000/api/biometric/devices/scan');
                    if (backendResponse.ok) {
                        const backendData = await backendResponse.json();
                        if (backendData.success && backendData.devices) {
                            devices.push(...backendData.devices.map(d => ({...d, source: 'backend'})));
                            log(`‚úÖ Added ${backendData.devices.length} backend devices`);
                        }
                    } else {
                        log(`‚ö†Ô∏è Backend devices skipped: HTTP ${backendResponse.status}`);
                    }
                } catch (e) {
                    log(`‚ö†Ô∏è Backend devices skipped: ${e.message}`);
                }

                // Step 3: Fallback to mock devices if needed
                if (devices.length === 0) {
                    log('Step 3: Creating mock devices...');
                    devices = [
                        {
                            deviceId: 'mock-fingerprint-1',
                            name: 'Virtual Fingerprint Scanner',
                            vendor: 'Virtual',
                            model: 'FP-1000',
                            category: 'fingerprint',
                            status: 'connected',
                            source: 'mock'
                        },
                        {
                            deviceId: 'mock-face-1',
                            name: 'Virtual Face Camera',
                            vendor: 'Virtual',
                            model: 'FC-2000',
                            category: 'face',
                            status: 'connected',
                            source: 'mock'
                        }
                    ];
                    log(`‚úÖ Created ${devices.length} mock devices`);
                }

                // Step 4: Update selector
                log('Step 4: Updating device selector...');
                const selector = document.getElementById('testDeviceSelector');
                const options = devices.map(device => {
                    const deviceName = device.vendor && device.model ? 
                        `${device.vendor} ${device.model}` : 
                        device.name || `${device.category || 'Unknown'} Device`;
                    
                    const sourceInfo = device.source === 'agent' ? ' (Agent)' : 
                                     device.source === 'mock' ? ' (Virtual)' : 
                                     device.source === 'backend' ? ' (Backend)' : '';
                    
                    return `<option value="${device.deviceId}">${deviceName}${sourceInfo}</option>`;
                }).join('');
                
                const defaultOption = devices.length > 0 ? 
                    '<option value="">Select a device</option>' : 
                    '<option value="">No devices available</option>';
                
                selector.innerHTML = defaultOption + options;
                
                log(`‚úÖ Updated selector with ${devices.length} devices`);
                
                updateResult('integratedResult', `
                    <strong>‚úÖ Integrated Loading Complete!</strong><br/>
                    Total devices: ${devices.length}<br/>
                    Agent devices: ${devices.filter(d => d.source === 'agent').length}<br/>
                    Backend devices: ${devices.filter(d => d.source === 'backend').length}<br/>
                    Mock devices: ${devices.filter(d => d.source === 'mock').length}<br/>
                    <pre>${JSON.stringify(devices, null, 2)}</pre>
                `);

                return devices;
            } catch (error) {
                log(`‚ùå Integrated loading failed: ${error.message}`);
                updateResult('integratedResult', `‚ùå Integrated loading failed: ${error.message}`, false);
                return [];
            }
        }

        // Auto-run basic tests on page load
        window.addEventListener('load', async () => {
            log('üöÄ Starting automatic tests...');
            await testAgentStatus();
            await testAgentDevices();
            await testBackendDevices();
            log('‚úÖ Basic tests completed. Run integrated test manually.');
        });
    </script>
</body>
</html>
